<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Flight - AeroFlow</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f0f4f8;
        min-height: 100vh;
      }

      /* Navbar */
      .navbar {
        background: #1e3a8a;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 15px 0;
      }

      .navbar-brand {
        color: white;
        font-size: 28px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .navbar-brand:hover {
        color: white;
      }

      .navbar-brand i {
        font-size: 32px;
      }

      .btn-back {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 6px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s;
      }

      .btn-back:hover {
        background: #2563eb;
        color: white;
      }

      /* Main Container */
      .main-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 20px;
      }

      .page-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .page-header h1 {
        color: #1e293b;
        font-weight: 700;
        font-size: 36px;
        margin-bottom: 10px;
      }

      .page-header p {
        color: #64748b;
        font-size: 18px;
      }

      /* Booking Layout */
      .booking-layout {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 30px;
      }

      /* Flight Summary Card */
      .flight-summary {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        position: sticky;
        top: 20px;
        height: fit-content;
      }

      .flight-summary h3 {
        color: #1e3a8a;
        font-weight: 700;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e2e8f0;
      }

      .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #f1f5f9;
      }

      .summary-label {
        color: #64748b;
        font-weight: 600;
      }

      .summary-value {
        color: #1e293b;
        font-weight: 700;
      }

      .route-display {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 8px;
        margin: 20px 0;
      }

      .route-airport {
        font-size: 28px;
        font-weight: 700;
        color: #1e3a8a;
      }

      .route-arrow {
        color: #94a3b8;
        font-size: 24px;
      }

      .total-price {
        background: #f0fdf4;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        text-align: center;
      }

      .total-label {
        color: #15803d;
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .total-amount {
        color: #15803d;
        font-size: 36px;
        font-weight: 700;
        margin-top: 5px;
      }

      /* Booking Form */
      .booking-form {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .form-section {
        margin-bottom: 30px;
      }

      .form-section h4 {
        color: #1e3a8a;
        font-weight: 700;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        font-weight: 600;
        color: #475569;
        margin-bottom: 8px;
        display: block;
      }

      .required {
        color: #ef4444;
      }

      .form-control,
      .form-select {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 12px;
        font-size: 15px;
        width: 100%;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      /* Class Selection */
      .class-selection {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .class-option {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }

      .class-option:hover {
        border-color: #3b82f6;
        background: #f8fafc;
      }

      .class-option.selected {
        border-color: #3b82f6;
        background: #eff6ff;
      }

      .class-option input[type="radio"] {
        display: none;
      }

      .class-name {
        font-weight: 700;
        color: #1e293b;
        font-size: 18px;
        margin-bottom: 8px;
      }

      .class-price {
        font-size: 24px;
        font-weight: 700;
        color: #10b981;
      }

      /* Seat Selection */
      .seat-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 10px;
        margin-top: 20px;
      }

      .seat {
        aspect-ratio: 1;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .seat:hover {
        border-color: #3b82f6;
        transform: scale(1.05);
      }

      .seat.available {
        background: white;
        color: #1e293b;
      }

      .seat.selected {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
      }

      .seat.occupied {
        background: #f1f5f9;
        color: #94a3b8;
        cursor: not-allowed;
      }

      .seat-legend {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-top: 20px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 600;
        color: #64748b;
      }

      .legend-box {
        width: 20px;
        height: 20px;
        border-radius: 4px;
      }

      /* Submit Button */
      .btn-submit {
        background: #10b981;
        color: white;
        border: none;
        padding: 16px 40px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 18px;
        width: 100%;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-submit:hover {
        background: #059669;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      }

      .btn-submit:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        transform: none;
      }

      /* Loading */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .loading-content {
        background: white;
        padding: 40px;
        border-radius: 12px;
        text-align: center;
      }

      .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 4px;
        color: #3b82f6;
      }

      /* Booking Toggle */
      .booking-toggle {
        margin-bottom: 20px;
        padding: 15px;
        background: #eff6ff;
        border-radius: 8px;
        border: 2px solid #3b82f6;
      }

      .form-check-input {
        cursor: pointer;
        width: 50px;
        height: 25px;
      }

      .form-check-label {
        font-weight: 600;
        color: #1e3a8a;
        cursor: pointer;
        margin-left: 10px;
      }

      /* Responsive */
      @media (max-width: 992px) {
        .booking-layout {
          grid-template-columns: 1fr;
        }

        .flight-summary {
          position: relative;
          top: 0;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .seat-grid {
          grid-template-columns: repeat(4, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="container-fluid">
        <a class="navbar-brand" href="flight-search.html">
          <i class="fas fa-plane-departure"></i>
          AeroFlow
        </a>
        <a href="flight-search.html" class="btn-back">
          <i class="fas fa-arrow-left"></i> Back to Search
        </a>
      </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
      <div class="page-header">
        <h1>Complete Your Booking</h1>
        <p>Fill in your details to confirm your flight reservation</p>
      </div>

      <div class="booking-layout">
        <!-- Booking Form -->
        <div class="booking-form">
          <form id="bookingForm">
            <!-- Passenger Information -->
            <div class="form-section">
              <h4>
                <i class="fas fa-user"></i>
                Passenger Information
              </h4>

              <!-- Book for Someone Else Toggle -->
              <div id="bookingToggleContainer"></div>

              <div class="form-group">
                <label class="form-label"
                  >Full Name <span class="required">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="passengerName"
                  required
                />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label"
                    >Email <span class="required">*</span></label
                  >
                  <input
                    type="email"
                    class="form-control"
                    id="passengerEmail"
                    required
                  />
                </div>
                <div class="form-group">
                  <label class="form-label"
                    >Phone <span class="required">*</span></label
                  >
                  <input
                    type="tel"
                    class="form-control"
                    id="passengerPhone"
                    required
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label"
                    >Passport Number <span class="required">*</span></label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="passportNumber"
                    required
                  />
                </div>
                <div class="form-group">
                  <label class="form-label"
                    >Date of Birth <span class="required">*</span></label
                  >
                  <input
                    type="date"
                    class="form-control"
                    id="dateOfBirth"
                    required
                  />
                </div>
              </div>

              <div class="form-group">
                <label class="form-label"
                  >Nationality <span class="required">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="nationality"
                  required
                />
              </div>
            </div>

            <!-- Class Selection -->
            <div class="form-section">
              <h4>
                <i class="fas fa-chair"></i>
                Select Class
              </h4>

              <div
                class="class-selection"
                style="grid-template-columns: repeat(3, 1fr)"
              >
                <label class="class-option" id="economyOption">
                  <input type="radio" name="class" value="economy" checked />
                  <div class="class-name">Economy</div>
                  <div class="class-price" id="economyPrice">$0</div>
                  <small style="color: #64748b">Rows 10-30</small>
                </label>
                <label class="class-option" id="businessOption">
                  <input type="radio" name="class" value="business" />
                  <div class="class-name">Business</div>
                  <div class="class-price" id="businessPrice">$0</div>
                  <small style="color: #64748b">Rows 4-9</small>
                </label>
                <label class="class-option" id="firstOption">
                  <input type="radio" name="class" value="first" />
                  <div class="class-name">First Class</div>
                  <div class="class-price" id="firstPrice">$0</div>
                  <small style="color: #64748b">Rows 1-3</small>
                </label>
              </div>
            </div>

            <!-- Seat Selection -->
            <div class="form-section">
              <h4>
                <i class="fas fa-couch"></i>
                Select Your Seat
              </h4>

              <p style="color: #64748b; margin-bottom: 15px">
                Click on an available seat to select it
              </p>

              <div class="seat-grid" id="seatGrid">
                <!-- Seats will be generated here -->
              </div>

              <div class="seat-legend">
                <div class="legend-item">
                  <div
                    class="legend-box"
                    style="background: white; border: 2px solid #e2e8f0"
                  ></div>
                  <span>Available</span>
                </div>
                <div class="legend-item">
                  <div class="legend-box" style="background: #3b82f6"></div>
                  <span>Selected</span>
                </div>
                <div class="legend-item">
                  <div class="legend-box" style="background: #f1f5f9"></div>
                  <span>Occupied</span>
                </div>
              </div>

              <input type="hidden" id="selectedSeat" />
            </div>

            <!-- Baggage -->
            <div class="form-section">
              <h4>
                <i class="fas fa-suitcase"></i>
                Baggage Information (Optional)
              </h4>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Baggage Weight (kg)</label>
                  <input
                    type="number"
                    class="form-control"
                    id="baggageWeight"
                    min="0"
                    max="50"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">Baggage Type</label>
                  <select class="form-select" id="baggageType">
                    <option value="">No baggage</option>
                    <option value="checked">Checked Baggage</option>
                    <option value="carry-on">Carry-on</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Submit -->
            <button type="submit" class="btn-submit">
              <i class="fas fa-check-circle"></i> Confirm Booking
            </button>
          </form>
        </div>

        <!-- Flight Summary -->
        <div class="flight-summary">
          <h3>Flight Summary</h3>

          <div class="summary-item">
            <span class="summary-label">Flight Number</span>
            <span class="summary-value" id="summaryFlightNumber">-</span>
          </div>

          <div class="route-display">
            <div class="route-airport" id="summaryOrigin">-</div>
            <div class="route-arrow">
              <i class="fas fa-plane"></i>
              <i class="fas fa-arrow-right"></i>
            </div>
            <div class="route-airport" id="summaryDestination">-</div>
          </div>

          <div class="summary-item">
            <span class="summary-label">Departure</span>
            <span class="summary-value" id="summaryDeparture">-</span>
          </div>

          <div class="summary-item">
            <span class="summary-label">Arrival</span>
            <span class="summary-value" id="summaryArrival">-</span>
          </div>

          <div class="summary-item">
            <span class="summary-label">Gate</span>
            <span class="summary-value" id="summaryGate">-</span>
          </div>

          <div class="summary-item">
            <span class="summary-label">Class</span>
            <span class="summary-value" id="summaryClass">Economy</span>
          </div>

          <div class="summary-item">
            <span class="summary-label">Seat</span>
            <span class="summary-value" id="summarySeat">Not selected</span>
          </div>

          <div class="total-price">
            <div class="total-label">Total Price</div>
            <div class="total-amount" id="totalPrice">$0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none">
      <div class="loading-content">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Processing your booking...</p>
      </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/config.js"></script>

    <script>
      // Configuration
      let selectedFlight = null;
      let aircraftConfig = null;
      let occupiedSeats = [];
      let selectedSeatNumber = null;
      let currentPrice = 0;
      let currentClass = "economy";
      let currentUser = null;
      let bookingForSelf = true;

      // Check login
      function checkLoginForBooking() {
        const token = localStorage.getItem("token");
        if (!token) {
          alert("Please login to book a flight");
          window.location.href = "../auth/login.html";
          return false;
        }
        return true;
      }

      // Initialize
      $(document).ready(function () {
        if (!checkLoginForBooking()) return;

        loadUserProfile();
        loadFlightDetails();
        setupEventListeners();
      });

      // Load user profile from localStorage (already has all data from login)
      function loadUserProfile() {
        const userStr = localStorage.getItem("user");

        if (userStr) {
          currentUser = JSON.parse(userStr);

          $("#passengerName").val(currentUser.name || "");
          $("#passengerEmail").val(currentUser.email || "");

          if (currentUser.phone) $("#passengerPhone").val(currentUser.phone);
          if (currentUser.passportNumber)
            $("#passportNumber").val(currentUser.passportNumber);
          if (currentUser.dateOfBirth) {
            const dob = currentUser.dateOfBirth.split("T")[0];
            $("#dateOfBirth").val(dob);
          }
          if (currentUser.nationality)
            $("#nationality").val(currentUser.nationality);

          addBookingToggle();
        }
      }

      // Add booking toggle
      function addBookingToggle() {
        const toggleHtml = `
          <div class="booking-toggle">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="bookForSomeoneElse">
              <label class="form-check-label" for="bookForSomeoneElse">
                <i class="fas fa-user-friends"></i> Book for someone else
              </label>
            </div>
            <small style="color: #64748b; display: block; margin-top: 8px; margin-left: 60px;">
              Toggle this if you're booking on behalf of another passenger
            </small>
          </div>
        `;

        $("#bookingToggleContainer").html(toggleHtml);

        $("#bookForSomeoneElse").on("change", function () {
          bookingForSelf = !$(this).is(":checked");

          if (bookingForSelf) {
            loadUserProfile();
            $(
              "#passengerName, #passengerEmail, #passengerPhone, #passportNumber, #dateOfBirth, #nationality"
            )
              .prop("readonly", true)
              .css({
                "background-color": "#f8fafc",
                "border-color": "#cbd5e1",
              });
          } else {
            $(
              "#passengerName, #passengerEmail, #passengerPhone, #passportNumber, #dateOfBirth, #nationality"
            )
              .val("")
              .prop("readonly", false)
              .css({ "background-color": "white", "border-color": "#e2e8f0" });
          }
        });

        $(
          "#passengerName, #passengerEmail, #passengerPhone, #passportNumber, #dateOfBirth, #nationality"
        )
          .prop("readonly", true)
          .css({ "background-color": "#f8fafc", "border-color": "#cbd5e1" });
      }

      function setupEventListeners() {
        $('input[name="class"]').on("change", function () {
          currentClass = $(this).val();
          updateClassSelection();
          updatePrice();
          generateSeats(currentClass);
        });

        $("#bookingForm").on("submit", function (e) {
          e.preventDefault();
          submitBooking();
        });
      }

      function loadFlightDetails() {
        const flightData = localStorage.getItem("selectedFlight");
        if (!flightData) {
          alert("No flight selected");
          window.location.href = "flight-search.html";
          return;
        }

        const flight = JSON.parse(flightData);
        $.ajax({
          url: `${API_URL}/flights/${flight.id}`,
          method: "GET",
          success: function (response) {
            selectedFlight = response.flight || response;
            if (selectedFlight.aircraft) {
              loadAircraftConfig(selectedFlight.aircraft);
            } else {
              displayFlightSummary();
              loadOccupiedSeats();
            }
          },
        });
      }

      function loadAircraftConfig(aircraftType) {
        $.ajax({
          url: `${API_URL}/aircraft-types/${aircraftType}`,
          method: "GET",
          success: function (response) {
            aircraftConfig = response.aircraft;
            displayFlightSummary();
            loadOccupiedSeats();
          },
          error: function () {
            aircraftConfig = null;
            displayFlightSummary();
            loadOccupiedSeats();
          },
        });
      }

      function displayFlightSummary() {
        $("#summaryFlightNumber").text(selectedFlight.flightNumber);
        $("#summaryOrigin").text(selectedFlight.origin);
        $("#summaryDestination").text(selectedFlight.destination);
        $("#summaryDeparture").text(
          formatDateTime(selectedFlight.departureTime)
        );
        $("#summaryArrival").text(formatDateTime(selectedFlight.arrivalTime));
        $("#summaryGate").text(selectedFlight.gate);

        if (selectedFlight.price) {
          $("#economyPrice").text("$" + selectedFlight.price.economy);
          $("#businessPrice").text("$" + selectedFlight.price.business);
          if (
            selectedFlight.capacity?.first > 0 &&
            selectedFlight.price.first
          ) {
            $("#firstPrice").text("$" + selectedFlight.price.first);
            $("#firstOption").show();
          } else {
            $("#firstOption").hide();
          }
          currentPrice = selectedFlight.price.economy;
          $("#totalPrice").text("$" + currentPrice);
        }
        $("#economyOption").addClass("selected");
      }

      function updateClassSelection() {
        $(".class-option").removeClass("selected");
        const selectedClass = $('input[name="class"]:checked').val();
        $(`#${selectedClass}Option`).addClass("selected");
        $("#summaryClass").text(
          selectedClass === "first"
            ? "First Class"
            : selectedClass.charAt(0).toUpperCase() + selectedClass.slice(1)
        );
      }

      function updatePrice() {
        const selectedClass = $('input[name="class"]:checked').val();
        if (selectedFlight.price[selectedClass]) {
          currentPrice = selectedFlight.price[selectedClass];
          $("#totalPrice").text("$" + currentPrice);
        }
      }

      function generateSeats(travelClass = "economy") {
        const seatGrid = $("#seatGrid");
        seatGrid.empty();

        let rows = 20,
          seatsPerRow = 6,
          startRow = 9,
          columns = ["A", "B", "C", "D", "E", "F"];
        if (travelClass === "business") {
          rows = 6;
          seatsPerRow = 4;
          startRow = 3;
          columns = ["A", "B", "C", "D"];
        }
        if (travelClass === "first") {
          rows = 2;
          seatsPerRow = 4;
          startRow = 1;
          columns = ["A", "B", "C", "D"];
        }

        for (let row = startRow; row < startRow + rows; row++) {
          for (let col = 0; col < seatsPerRow; col++) {
            const seatNumber = `${row}${columns[col]}`;
            const isOccupied = occupiedSeats.includes(seatNumber);
            const seatEl = $(
              `<div class="seat ${
                isOccupied ? "occupied" : "available"
              }" data-seat="${seatNumber}">${seatNumber}</div>`
            );
            if (!isOccupied) seatEl.on("click", () => selectSeat(seatNumber));
            seatGrid.append(seatEl);
            if (
              (travelClass === "economy" && col === 2) ||
              ((travelClass === "business" || travelClass === "first") &&
                col === 1)
            ) {
              seatGrid.append('<div style="grid-column: span 1;"></div>');
            }
          }
        }
      }

      function loadOccupiedSeats() {
        $.ajax({
          url: `${API_URL}/bookings`,
          method: "GET",
          data: { flightId: selectedFlight._id },
          success: function (response) {
            occupiedSeats = [];
            let bookings = response.data || response.bookings || response;
            if (Array.isArray(bookings)) {
              bookings.forEach((b) => {
                if (b.seatNumber && b.status !== "cancelled")
                  occupiedSeats.push(b.seatNumber);
              });
            }
            generateSeats(currentClass);
          },
          error: () => generateSeats(currentClass),
        });
      }

      function selectSeat(seatNumber) {
        $(".seat").removeClass("selected");
        $(`.seat[data-seat="${seatNumber}"]`).addClass("selected");
        selectedSeatNumber = seatNumber;
        $("#selectedSeat").val(seatNumber);
        $("#summarySeat").text(seatNumber);
      }

      function submitBooking() {
        if (!selectedSeatNumber) {
          alert("Please select a seat");
          return;
        }

        const passengerData = {
          name: $("#passengerName").val().trim(),
          email: $("#passengerEmail").val().trim(),
          phone: $("#passengerPhone").val().trim(),
          passportNumber: $("#passportNumber").val().trim(),
          dateOfBirth: $("#dateOfBirth").val(),
          nationality: $("#nationality").val().trim(),
        };

        const bookingClass = $('input[name="class"]:checked').val();
        const baggage = [];
        const baggageWeight = $("#baggageWeight").val();
        const baggageType = $("#baggageType").val();
        if (baggageWeight && baggageType)
          baggage.push({ weight: parseInt(baggageWeight), type: baggageType });

        $("#loadingOverlay").fadeIn();
        createPassenger(passengerData, bookingClass, baggage);
      }

      function createPassenger(passengerData, bookingClass, baggage) {
        $.ajax({
          url: `${API_URL}/passengers`,
          method: "POST",
          headers: { "Content-Type": "application/json" },
          data: JSON.stringify(passengerData),
          success: function (response) {
            const passenger = response.passenger || response.data || response;
            createBooking(passenger._id, bookingClass, baggage, passengerData);
          },
          error: function (xhr) {
            if (
              xhr.status === 400 &&
              xhr.responseJSON?.error?.includes("already exists")
            ) {
              findExistingPassenger(
                passengerData.passportNumber,
                bookingClass,
                baggage,
                passengerData
              );
            } else {
              $("#loadingOverlay").hide();
              alert(xhr.responseJSON?.error || "Failed to create passenger");
            }
          },
        });
      }

      function findExistingPassenger(
        passport,
        bookingClass,
        baggage,
        passengerData
      ) {
        $.ajax({
          url: `${API_URL}/passengers/passport/${passport}`,
          method: "GET",
          success: function (response) {
            const passenger = response.passenger || response.data || response;
            createBooking(passenger._id, bookingClass, baggage, passengerData);
          },
          error: function () {
            $("#loadingOverlay").hide();
            alert("Error finding passenger");
          },
        });
      }

      function createBooking(
        passengerId,
        bookingClass,
        baggage,
        passengerData
      ) {
        const bookingData = {
          flightId: selectedFlight._id,
          passengerId: passengerId,
          seatNumber: selectedSeatNumber,
          class: bookingClass,
          baggage: baggage,
        };

        $.ajax({
          url: `${API_URL}/bookings`,
          method: "POST",
          headers: { "Content-Type": "application/json" },
          data: JSON.stringify(bookingData),
          success: function (response) {
            $("#loadingOverlay").hide();
            const booking = response.booking || response.data || response;
            localStorage.setItem(
              "lastBooking",
              JSON.stringify({
                reference: booking.bookingReference,
                flightNumber: selectedFlight.flightNumber,
                origin: selectedFlight.origin,
                destination: selectedFlight.destination,
                departureTime: formatDateTime(selectedFlight.departureTime),
                arrivalTime: formatDateTime(selectedFlight.arrivalTime),
                gate: selectedFlight.gate,
                passenger: passengerData.name,
                passportNumber: passengerData.passportNumber,
                email: passengerData.email,
                phone: passengerData.phone,
                seat: selectedSeatNumber,
                class: bookingClass,
              })
            );
            window.location.href = "booking-confirmation.html";
          },
          error: function (xhr) {
            $("#loadingOverlay").hide();
            alert(
              "Booking Error: " +
                (xhr.responseJSON?.error || "Failed to create booking")
            );
          },
        });
      }

      function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }
    </script>
  </body>
</html>
