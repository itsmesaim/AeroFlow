<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Booking Details - AeroFlow</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f0f4f8;
        min-height: 100vh;
      }

      .navbar {
        background: #1e3a8a;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 15px 0;
      }

      .navbar-brand {
        color: white;
        font-size: 28px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .btn-back {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 6px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s;
      }

      .btn-back:hover {
        background: #2563eb;
        color: white;
      }

      .main-container {
        max-width: 1000px;
        margin: 40px auto;
        padding: 0 20px;
      }

      .page-header {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border-left: 4px solid #1e3a8a;
      }

      .page-header h1 {
        color: #1e3a8a;
        font-weight: 700;
        margin-bottom: 10px;
      }

      .booking-reference {
        font-size: 24px;
        color: #3b82f6;
        font-weight: 700;
      }

      .details-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .card-title {
        color: #1e3a8a;
        font-weight: 700;
        font-size: 20px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .detail-row {
        display: grid;
        grid-template-columns: 200px 1fr;
        padding: 15px 0;
        border-bottom: 1px solid #f1f5f9;
      }

      .detail-label {
        color: #64748b;
        font-weight: 600;
      }

      .detail-value {
        color: #1e293b;
        font-weight: 700;
      }

      .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
        display: inline-block;
      }

      .status-confirmed {
        background: #dbeafe;
        color: #1e40af;
      }

      .status-checked-in {
        background: #dcfce7;
        color: #166534;
      }

      .status-boarded {
        background: #f3e8ff;
        color: #6b21a8;
      }

      .flight-route {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        padding: 30px;
        background: #f8fafc;
        border-radius: 10px;
        margin: 20px 0;
      }

      .route-airport {
        font-size: 32px;
        font-weight: 700;
        color: #1e3a8a;
      }

      .route-icon {
        color: #3b82f6;
        font-size: 24px;
      }

      .loading {
        text-align: center;
        padding: 60px 20px;
      }

      .spinner {
        border: 4px solid #e2e8f0;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-message {
        text-align: center;
        padding: 60px 20px;
        color: #ef4444;
      }

      .action-buttons {
        display: flex;
        gap: 15px;
        margin-top: 30px;
      }

      .btn-action {
        flex: 1;
        padding: 14px 24px;
        border-radius: 8px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: #3b82f6;
        color: white;
      }

      .btn-primary:hover {
        background: #2563eb;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="fas fa-plane-departure"></i>
          AeroFlow
        </a>
        <a href="javascript:history.back()" class="btn-back">
          <i class="fas fa-arrow-left"></i> Back
        </a>
      </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
      <!-- Loading State -->
      <div id="loadingState" class="details-card">
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading booking details...</p>
        </div>
      </div>

      <!-- Error State -->
      <div id="errorState" class="details-card" style="display: none">
        <div class="error-message">
          <i
            class="fas fa-exclamation-circle"
            style="font-size: 64px; margin-bottom: 20px"
          ></i>
          <h3>Booking Not Found</h3>
          <p id="errorMessage">Unable to load booking details</p>
        </div>
      </div>

      <!-- Booking Details -->
      <div id="bookingDetails" style="display: none">
        <!-- Header -->
        <div class="page-header">
          <h1><i class="fas fa-ticket-alt"></i> Booking Details</h1>
          <p class="booking-reference">
            Reference: <span id="bookingRef">-</span>
          </p>
        </div>

        <!-- Flight Information -->
        <div class="details-card">
          <div class="card-title">
            <i class="fas fa-plane"></i>
            Flight Information
          </div>

          <div class="flight-route">
            <div class="route-airport" id="flightOrigin">-</div>
            <div class="route-icon">
              <i class="fas fa-plane"></i>
              <i class="fas fa-arrow-right"></i>
            </div>
            <div class="route-airport" id="flightDestination">-</div>
          </div>

          <div class="detail-row">
            <span class="detail-label">Flight Number</span>
            <span class="detail-value" id="flightNumber">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Departure Time</span>
            <span class="detail-value" id="departureTime">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Arrival Time</span>
            <span class="detail-value" id="arrivalTime">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Gate</span>
            <span class="detail-value" id="gate">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Status</span>
            <span class="detail-value" id="flightStatus">-</span>
          </div>
        </div>

        <!-- Passenger Information -->
        <div class="details-card">
          <div class="card-title">
            <i class="fas fa-user"></i>
            Passenger Information
          </div>
          <div class="detail-row">
            <span class="detail-label">Name</span>
            <span class="detail-value" id="passengerName">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Email</span>
            <span class="detail-value" id="passengerEmail">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Phone</span>
            <span class="detail-value" id="passengerPhone">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Passport Number</span>
            <span class="detail-value" id="passportNumber">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Nationality</span>
            <span class="detail-value" id="nationality">-</span>
          </div>
        </div>

        <!-- Booking Information -->
        <div class="details-card">
          <div class="card-title">
            <i class="fas fa-info-circle"></i>
            Booking Information
          </div>
          <div class="detail-row">
            <span class="detail-label">Seat Number</span>
            <span class="detail-value" id="seatNumber">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Class</span>
            <span class="detail-value" id="cabinClass">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Booking Status</span>
            <span class="detail-value">
              <span class="status-badge" id="bookingStatus">-</span>
            </span>
          </div>
          <div class="detail-row" id="checkInTimeRow" style="display: none">
            <span class="detail-label">Check-in Time</span>
            <span class="detail-value" id="checkInTime">-</span>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons" id="actionButtons">
          <!-- Buttons will be added here based on status -->
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/config.js"></script>

    <script>
      $(document).ready(function () {
        const urlParams = new URLSearchParams(window.location.search);
        const bookingId = urlParams.get("id");

        if (!bookingId) {
          showError("No booking ID provided");
          return;
        }

        loadBookingDetails(bookingId);
      });

      function loadBookingDetails(bookingId) {
        $.ajax({
          url: `${API_URL}/bookings/${bookingId}`,
          method: "GET",
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
          success: function (response) {
            const booking = response.booking || response.data || response;
            displayBookingDetails(booking);
          },
          error: function (xhr) {
            showError(
              xhr.responseJSON?.message || "Failed to load booking details"
            );
          },
        });
      }

      function displayBookingDetails(booking) {
        $("#loadingState").hide();
        $("#bookingDetails").show();

        // Booking Reference
        $("#bookingRef").text(booking.bookingReference);

        // Flight Information
        const flight = booking.flight || booking.flightId || {};
        $("#flightOrigin").text(flight.origin || "N/A");
        $("#flightDestination").text(flight.destination || "N/A");
        $("#flightNumber").text(flight.flightNumber || "N/A");
        $("#departureTime").text(
          flight.departureTime ? formatDateTime(flight.departureTime) : "N/A"
        );
        $("#arrivalTime").text(
          flight.arrivalTime ? formatDateTime(flight.arrivalTime) : "N/A"
        );
        $("#gate").text(flight.gate || "Not assigned");
        $("#flightStatus").text(flight.status || "N/A");

        // Passenger Information
        const passenger = booking.passenger || booking.passengerId || {};
        $("#passengerName").text(passenger.name || "N/A");
        $("#passengerEmail").text(passenger.email || "N/A");
        $("#passengerPhone").text(passenger.phone || "N/A");
        $("#passportNumber").text(passenger.passportNumber || "N/A");
        $("#nationality").text(passenger.nationality || "N/A");

        // Booking Information
        $("#seatNumber").text(booking.seatNumber || "Not assigned");
        $("#cabinClass").text(
          (booking.class || booking.cabinClass || "economy").toUpperCase()
        );

        // Status
        const status = booking.status || "confirmed";
        const statusClass =
          status === "boarded"
            ? "status-boarded"
            : status === "checked-in"
            ? "status-checked-in"
            : "status-confirmed";
        $("#bookingStatus")
          .removeClass("status-confirmed status-checked-in status-boarded")
          .addClass(statusClass)
          .text(status.charAt(0).toUpperCase() + status.slice(1));

        // Check-in time
        if (booking.checkInTime) {
          $("#checkInTimeRow").show();
          $("#checkInTime").text(formatDateTime(booking.checkInTime));
        }

        // Action Buttons
        renderActionButtons(booking);
      }

      function renderActionButtons(booking) {
        const buttons = $("#actionButtons");
        buttons.empty();

        const status = booking.status || "confirmed";

        // Print Boarding Pass (if checked-in or boarded)
        if (status === "checked-in" || status === "boarded") {
          buttons.append(`
            <button class="btn-action btn-primary" onclick="printBoardingPass()">
              <i class="fas fa-print"></i> Print Boarding Pass
            </button>
          `);
        }

        // Check-in button (if not checked-in)
        if (status === "confirmed") {
          buttons.append(`
            <button class="btn-action btn-success" onclick="checkIn('${booking._id}')">
              <i class="fas fa-check"></i> Check In
            </button>
          `);
        }

        // Cancel Booking (if not boarded)
        if (status !== "boarded" && status !== "cancelled") {
          buttons.append(`
            <button class="btn-action btn-danger" onclick="cancelBooking('${booking._id}')">
              <i class="fas fa-times"></i> Cancel Booking
            </button>
          `);
        }
      }

      function checkIn(bookingId) {
        if (!confirm("Confirm check-in for this booking?")) return;

        $.ajax({
          url: `${API_URL}/bookings/${bookingId}/checkin`,
          method: "PUT",
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
          success: function () {
            alert("Check-in successful!");
            location.reload();
          },
          error: function (xhr) {
            alert(
              "Check-in failed: " +
                (xhr.responseJSON?.message || "Unknown error")
            );
          },
        });
      }

      function cancelBooking(bookingId) {
        if (!confirm("Are you sure you want to cancel this booking?")) return;

        $.ajax({
          url: `${API_URL}/bookings/${bookingId}`,
          method: "DELETE",
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
          success: function () {
            alert("Booking cancelled successfully");
            window.location.href = "/pages/public/my-bookings.html";
          },
          error: function (xhr) {
            alert(
              "Cancellation failed: " +
                (xhr.responseJSON?.message || "Unknown error")
            );
          },
        });
      }

      function printBoardingPass() {
        alert("Boarding pass printing feature coming soon!");
        // TODO: Implement PDF generation
      }

      function showError(message) {
        $("#loadingState").hide();
        $("#errorState").show();
        $("#errorMessage").text(message);
      }

      function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }
    </script>
  </body>
</html>
