// Configuration
const API_URL = "http://localhost:5000/api";

// Initialize on page load
$(document).ready(function () {
  loadBookingDetails();
});

// Load booking details from localStorage
function loadBookingDetails() {
  const bookingData = localStorage.getItem("lastBooking");

  if (!bookingData) {
    alert("No booking information found");
    window.location.href = "flight-search.html";
    return;
  }

  const booking = JSON.parse(bookingData);
  displayBookingDetails(booking);
}

// Display booking details
function displayBookingDetails(booking) {
  // Booking Reference
  $("#bookingReference").text(booking.reference);

  // Flight Details
  $("#flightNumber").text(booking.flightNumber);
  $("#originCode").text(booking.origin || "DUB");
  $("#destinationCode").text(booking.destination || "JFK");
  $("#departureTime").text(booking.departureTime || "Check itinerary");
  $("#arrivalTime").text(booking.arrivalTime || "Check itinerary");
  $("#gateNumber").text(booking.gate || "TBA");
  $("#bookingClass").text(capitalizeFirst(booking.class));
  $("#seatNumber").text(booking.seat);

  // Passenger Details
  $("#passengerName").text(booking.passenger);
  $("#passportNumber").text(booking.passportNumber || "N/A");
  $("#passengerEmail").text(booking.email || "N/A");
  $("#passengerPhone").text(booking.phone || "N/A");
}

// Capitalize first letter
function capitalizeFirst(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

// Download PDF
function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const bookingData = JSON.parse(localStorage.getItem("lastBooking"));

  // Title
  doc.setFontSize(24);
  doc.setFont(undefined, "bold");
  doc.text("AeroFlow - Booking Confirmation", 105, 20, { align: "center" });

  // Booking Reference
  doc.setFontSize(16);
  doc.setFont(undefined, "bold");
  doc.text("Booking Reference:", 20, 40);
  doc.setFontSize(20);
  doc.setTextColor(30, 58, 138);
  doc.text(bookingData.reference, 20, 50);
  doc.setTextColor(0, 0, 0);

  // Flight Details
  doc.setFontSize(14);
  doc.setFont(undefined, "bold");
  doc.text("Flight Details", 20, 70);
  doc.setFont(undefined, "normal");
  doc.setFontSize(11);

  let y = 80;
  doc.text(`Flight Number: ${bookingData.flightNumber}`, 20, y);
  y += 8;
  doc.text(
    `Route: ${bookingData.origin || "DUB"} → ${
      bookingData.destination || "JFK"
    }`,
    20,
    y
  );
  y += 8;
  doc.text(`Class: ${capitalizeFirst(bookingData.class)}`, 20, y);
  y += 8;
  doc.text(`Seat: ${bookingData.seat}`, 20, y);
  y += 8;
  doc.text(`Gate: ${bookingData.gate || "TBA"}`, 20, y);

  // Passenger Details
  y += 15;
  doc.setFontSize(14);
  doc.setFont(undefined, "bold");
  doc.text("Passenger Details", 20, y);
  doc.setFont(undefined, "normal");
  doc.setFontSize(11);

  y += 10;
  doc.text(`Name: ${bookingData.passenger}`, 20, y);
  y += 8;
  if (bookingData.passportNumber) {
    doc.text(`Passport: ${bookingData.passportNumber}`, 20, y);
    y += 8;
  }
  if (bookingData.email) {
    doc.text(`Email: ${bookingData.email}`, 20, y);
    y += 8;
  }
  if (bookingData.phone) {
    doc.text(`Phone: ${bookingData.phone}`, 20, y);
  }

  // Important Notice
  y += 20;
  doc.setFontSize(12);
  doc.setFont(undefined, "bold");
  doc.text("Important Information", 20, y);
  doc.setFont(undefined, "normal");
  doc.setFontSize(10);

  y += 8;
  doc.text("• Arrive at least 2 hours before departure", 20, y);
  y += 6;
  doc.text("• Valid ID and passport required at check-in", 20, y);
  y += 6;
  doc.text("• Web check-in opens 24 hours before departure", 20, y);

  // Footer
  doc.setFontSize(8);
  doc.setTextColor(100, 100, 100);
  doc.text("Generated by AeroFlow Airport Management System", 105, 280, {
    align: "center",
  });
  doc.text(new Date().toLocaleString(), 105, 285, { align: "center" });

  // Save PDF
  doc.save(`AeroFlow-Booking-${bookingData.reference}.pdf`);
}

// Email booking (placeholder for now)
function emailBooking() {
  const bookingData = JSON.parse(localStorage.getItem("lastBooking"));
  const email = bookingData.email || "";

  if (!email) {
    alert(
      "No email address found in booking. Please download the PDF instead."
    );
    return;
  }

  // For now, just show a message
  // Later we can implement actual email sending via API
  alert(
    `Booking confirmation will be sent to: ${email}\n\n(Email feature coming soon! For now, please download the PDF.)`
  );
}
